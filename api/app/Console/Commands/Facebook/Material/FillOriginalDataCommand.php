<?php

namespace App\Console\Commands\Facebook\Material;

use App\Helper\Tool;
use App\Models\Facebook\FacebookAdAccount;
use App\Models\Material\Material;
use App\Models\Material\MaterialHashId;
use App\Models\Material\OriginalMaterialData;
use App\Services\CompanyService;
use App\Services\Facebook\AdAccountService;
use App\Services\Facebook\BMService;
use App\Services\Facebook\CurlService;
use Carbon\Carbon;
use FacebookAds\Object\AdAccount;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;

class FillOriginalDataCommand extends Command
{
    protected $signature = 'FillOriginalDataCommand';

    protected $description = '补素材数据';

    public function __construct()
    {
        parent::__construct();
    }

    public function handle()
    {
        Log::info($this->description . "开始");
        $startTime = microtime(true);
        $aidList = [
            185328000361665, 202699255015928, 220000723677522, 254719930106489, 283686360629109, 284065470249494, 318027586798959, 319878606181453, 323725473208498, 333235858562139, 401361728757502, 412284020422883, 417021913807200, 417784380478462, 448866903546971, 449423070427814, 452821939738367, 455276066194066, 457492675918840, 464015715150783, 467367338127012, 554784776372657, 559492102573317, 574869163480644, 583754726226754, 592106662473667, 593112171922606, 615775926827598, 615806119779520, 633875088165398, 658271445173546, 685624512663426, 718548772706533, 730046368055884, 751108776126752, 781746386602560, 806703723828070, 869937717034636, 893521308189771, 974964496782282, 1063048134530996, 1089063662015947, 1107648276853320, 1112936032646325, 1116029808983822, 1154496218444269, 1162443490969819, 1185585488897551, 1216103872469933, 1221476998631843, 1238087009951641, 1241972916539457, 1251300592406958, 1289855914880670, 1363312790832969, 1445558439247788, 1482756195512570, 1616375132038968, 1935522156635815, 2049725765209865, 2216333111858391, 2808158119329365, 3098549073754620, 3113468908875725, 3206994526283591, 3251074658440633, 3468727140022422, 4732606223513397, 4830853033683358, 5213524968764371, 5236122849765498, 5413390942059936, 8480568585290334
        ];
        // $aidList = [1185585488897551];
        $tokenMap = array_column(BMService::getAllBM(), 'system_token', 'id');
        $accountMap = FacebookAdAccount::getIns()->listByCond(
            ['aid' => ['in', $aidList]],
            ['aid', 'bm_id']
        );
        $accountRs = array_column($accountMap, 'bm_id', 'aid');
        $sid = [23850714789920181, 23850400240080467, 23850376966790691, 23850365529520657, 23849830668350043, 23850385255580691, 23849329703000581, 23849838563170043, 23850507023670112, 23850854115790712, 23850426754430401, 23850444347540401, 23850444722190401, 23850465891770467, 23850435838020763, 23850683060300493, 23850692241270493, 23850908686330185, 23851642984230360, 23850622324440401, 23850510894550664, 23850673399580467, 23851177392470541, 23850854412650467, 23850692297130664, 23851056714890206, 23850713828330664, 23850807052260581, 23851350597110323, 23851884788260360, 23850672399540725, 23850903487550514, 23851036780330388, 23850808537330691, 23850990949030544, 23850992906540134, 23850556914860146, 23851091494960206, 23851252316900556, 23851313786540016, 23851324169060016, 23850850104860691, 23851021929220134, 23851594133700578, 23850976499600467, 23851041883200721, 23851197119020109, 23851120857130206, 23851204212360109, 23851057423210247, 23851339197820780, 23847878669060146, 23847825065630146, 23847712124700146, 23847694171390146, 23848240117400023, 23848188491390023, 23848108976260023, 23848086060620023, 23848067820890023, 23848577637180780, 23848570888390780, 23848431929450780, 23848396674770780, 23850935918660301, 23851058563680721, 23851290226110525, 23851081689370194, 23850945868990301, 23851539084380222, 23851297817670525, 23851093875830358, 23851097847520329, 23851097427410194, 23851115134480388, 23851021577150370, 23850622647470146, 23851023140510493, 23851163215550206, 23850580356350068, 23851099163250697, 23851480417000541, 23851098697590721, 23852004225320360, 23851785732920408, 23851785945020408, 23851143755140388, 23851460811790577, 23851143217240727, 23851125123140247, 23851153610020118, 23850928585290691, 23851307897970488, 23850661446070146, 23851317740200488, 23851072186190467, 23851070159960493, 23851144729210247, 23851367814700525, 23851174753270329, 23850953141720423, 23851031083910235, 23851665641730380, 23851031552220235, 23851031551270235, 23851031550010235, 23851031549350235, 23851031549240235, 23851031548450235, 23851031547840235, 23851031547390235, 23851031547090235, 23851031546170235, 23851031546050235, 23851031545690235, 23851031545200235, 23851031545110235, 23851031544240235, 23851031543500235, 23851031543380235, 23851031542830235, 23851031542330235, 23851031541190235, 23851031541060235, 23851031540470235, 23851031539680235, 23851031539110235, 23851031538260235, 23851639352790222, 23851265434940438, 23852830117880287, 23851469026690016, 23852087599840360, 23851368232630488, 23850513936440394, 23851206420680194, 23851683737700063, 23851190150200420, 23851128212610467, 23850979742890441, 23851107153040542, 23851168194670373, 23851503426670695, 23850829112600008, 23851516561840695, 23851418863650024, 23851135385540756, 23850910194460639, 23851720678170089, 23850992784010164, 23850971855780106, 23851203697260373, 23850977253180409, 23850711318730068, 23851360722910237, 23851764183410578, 23851535138680695, 23851249021320388, 23851234030780420, 23851406873810488, 23850690794500052, 23851046582130726, 23851268641210727, 23851008577810164, 23850965901740414, 23851545076120272, 23850971284650273, 23851113040020305, 23850979219350123, 23851540111070016, 23851267932180247, 23850811993250694, 23852899464210287, 23850574513150394, 23851120534240305, 23851394415630237, 23851229021530544, 23851173336960370, 23850904136390054, 23850914612760428, 23850902418480255, 23851029099440164, 23851238918000373, 23852006524960495, 23851570759370016, 23851460859140488, 23850870978690178, 23851302337350194, 23851346349050472, 23851978877770666, 23851352471000472, 23851392437100656, 23850577569200128, 23851383184140611, 23851639313800023, 23850954700710428, 23850939769530255, 23850955040500428, 23850955029390428, 23851417135320462, 23851067366830164, 23851455218320372];
        // $sid = [23851174753270329];
        foreach ($aidList as $aid) {
            $token = $tokenMap[$accountRs[$aid]];
            $rs = OriginalMaterialData::getIns()->listByCond(['aid' => $aid, 'adset_id' => ['in', $sid]], ['ad_id', 'date']);

            if (empty($rs)) {
                continue;
            }


            $dateArr = [];
            foreach ($rs as $row) {
                $dateArr[$row['date']][] = $row['ad_id'];
            }

            foreach ($dateArr as $date => $ids) {
                $dateFmt = date("Y-m-d", strtotime($date));
                $idChunks = array_chunk($ids, 50);
                foreach ($idChunks as $idChunk) {
                    [$status, $curlMsg, $res] = CurlService::getIns()->curlRequest(
                        "insights",
                        [
                            'fields'                          => [
                                'spend',
                                'impressions',
                                'clicks',
                                'actions'
                            ],
                            'use_unified_attribution_setting' => true,
                            'time_range'                      => [
                                'since' => $dateFmt,
                                'until' => $dateFmt
                            ],
                            'ids'                             => implode(',', $idChunk)
                        ],
                        $token
                    );


                    foreach ($res as $ad => $row) {
                        $data = $row['data'][0] ?? [];
                        if (empty($data)) {
                            continue;
                        }
                        $insert_data = [];
                        $insert_data["spend"] = $data["spend"] ?? 0;
                        $insert_data["impressions"] = $data["impressions"] ?? 0;
                        $insert_data["clicks"] = $data["clicks"] ?? 0;
                        $ac = array_column($data['actions'] ?? [], 'value', 'action_type');
                        $insert_data['purchase'] = $ac['omni_purchase'] ?? 0;
                        OriginalMaterialData::getIns()->updateOrInsert(
                            ['date' => $date, 'ad_id' => $ad],
                            $insert_data
                        );
                    }
                    usleep(20000);
                }
            }
        }

        Log::info($this->description . "use time:" . (microtime(true) - $startTime));
    }
}
